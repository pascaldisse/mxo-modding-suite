<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Online Modding Suite (MOMS)</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
    <script>
        // Ensure THREE is available globally
        window.THREE = THREE;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>
    
    <style>
        /* Custom styles */
        .matrix-theme {
            --matrix-green: #00ff00;
            --matrix-dark: #001a00;
            --matrix-black: #000800;
            --matrix-light: #ccffcc;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background-color: var(--matrix-black, #000800);
            color: var(--matrix-green, #00ff00);
        }
        
        .matrix-button {
            background-color: var(--matrix-dark, #001a00);
            color: var(--matrix-green, #00ff00);
            border: 1px solid var(--matrix-green, #00ff00);
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .matrix-button:hover {
            background-color: var(--matrix-green, #00ff00);
            color: var(--matrix-black, #000800);
        }
        
        .file-tree {
            height: calc(100vh - 60px);
            overflow-y: auto;
            background-color: var(--matrix-dark, #001a00);
            border-right: 1px solid var(--matrix-green, #00ff00);
        }
        
        .editor-container {
            height: calc(100vh - 60px);
            overflow: hidden;
            background-color: var(--matrix-black, #000800);
        }
        
        .preview-container {
            height: calc(100vh - 60px);
            overflow: hidden;
            background-color: var(--matrix-dark, #001a00);
            border-left: 1px solid var(--matrix-green, #00ff00);
        }
        
        .file-tree-item {
            padding: 4px 8px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 255, 0, 0.1);
        }
        
        .file-tree-item:hover {
            background-color: rgba(0, 255, 0, 0.1);
        }
        
        .file-tree-item.selected {
            background-color: rgba(0, 255, 0, 0.2);
        }
        
        .file-tree-folder {
            font-weight: bold;
        }
        
        .monaco-editor {
            height: 100%;
            width: 100%;
        }
        
        .webgl-container {
            width: 100%;
            height: 100%;
        }
        
        .matrix-header {
            background-color: var(--matrix-dark, #001a00);
            border-bottom: 2px solid var(--matrix-green, #00ff00);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .matrix-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--matrix-green, #00ff00);
            letter-spacing: 2px;
        }
        
        .loading-matrix {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--matrix-black, #000800);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-text {
            font-size: 24px;
            color: var(--matrix-green, #00ff00);
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .matrix-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.5;
        }
        
        /* Tailwind-like utility classes */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .m-2 { margin: 0.5rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .border { border-width: 1px; }
        .rounded { border-radius: 0.25rem; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
    </style>
</head>
<body class="matrix-theme">
    <div id="loading" class="loading-matrix">
        <canvas id="matrix-rain" class="matrix-rain"></canvas>
        <div class="loading-text" id="loading-text">Initializing Matrix Online Modding Suite...</div>
    </div>
    
    <div id="root"></div>

    <script type="text/babel">
        // Main React Application
        const { useState, useEffect, useRef } = React;
        
        // File type definitions for Lithtech engine
        const FILE_TYPES = {
            MODEL: {
                extensions: ['.abc', '.mob'],
                icon: '📊',
                name: 'Model',
                description: 'Lithtech 3D Model (Actor Binary Cache / Matrix Online Binary)'
            },
            TEXTURE: {
                extensions: ['.dtx', '.dds', '.tga', '.png', '.jpg', '.jpeg'],
                icon: '🖼️',
                name: 'Texture',
                description: 'Lithtech DirectX Texture or Image File'
            },
            LEVEL: {
                extensions: ['.dat', '.world'],
                icon: '🏙️',
                name: 'Level',
                description: 'Lithtech Level Data'
            },
            SOUND: {
                extensions: ['.wav', '.ogg', '.mp3'],
                icon: '🔊',
                name: 'Sound',
                description: 'Audio File'
            },
            CUTSCENE: {
                extensions: ['.bik', '.smk', '.avi', '.mp4'],
                icon: '🎬',
                name: 'Cutscene',
                description: 'Video or Cutscene File'
            },
            ANIMATION: {
                extensions: ['.anm', '.ani'],
                icon: '🎭',
                name: 'Animation',
                description: 'Character Animation Data'
            },
            SCRIPT: {
                extensions: ['.lua', '.cs', '.txt', '.py'],
                icon: '📜',
                name: 'Script',
                description: 'Game Script'
            },
            MESSAGE: {
                extensions: ['.msg'],
                icon: '💬',
                name: 'Message',
                description: 'In-Game Text'
            },
            ARCHIVE: {
                extensions: ['.rez', '.lta', '.ltb', '.pkb'],
                icon: '📦',
                name: 'Archive',
                description: 'Lithtech Resource Archive'
            },
            ASSEMBLY: {
                extensions: ['.dll', '.exe'],
                icon: '⚙️',
                name: 'Assembly',
                description: 'Executable or Library File'
            },
            OTHER: {
                extensions: [],
                icon: '📄',
                name: 'Other',
                description: 'Unknown File Type'
            }
        };
        
        // Utility functions
        const getFileType = (filename) => {
            if (!filename) return FILE_TYPES.OTHER;
            const ext = '.' + filename.split('.').pop().toLowerCase();
            
            for (const type in FILE_TYPES) {
                if (FILE_TYPES[type].extensions.includes(ext)) {
                    return FILE_TYPES[type];
                }
            }
            
            return FILE_TYPES.OTHER;
        };
        
        // File parsers for Lithtech engine formats
        const LithtechParsers = {
            // ABC Model Parser (simplified)
            parseABC: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const buffer = e.target.result;
                            // Check for ABC header (simplified)
                            const header = new Uint8Array(buffer, 0, 4);
                            const headerStr = String.fromCharCode(...header);
                            
                            if (headerStr !== 'ABCM') {
                                console.warn('Not a valid ABC file, missing ABCM header');
                            }
                            
                            // In a real implementation, this would parse the binary format
                            // For now, we'll return a placeholder object
                            resolve({
                                type: 'model',
                                vertices: [],
                                indices: [],
                                uvs: [],
                                normals: [],
                                animations: [],
                                materials: [],
                                metadata: {
                                    format: 'ABC',
                                    version: 1.0
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing ABC file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // DTX Texture Parser (simplified)
            parseDTX: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const buffer = e.target.result;
                            // Check for DTX header (simplified)
                            const header = new Uint8Array(buffer, 0, 4);
                            const headerStr = String.fromCharCode(...header);
                            
                            if (headerStr !== 'DTX\0') {
                                console.warn('Not a valid DTX file, missing DTX header');
                            }
                            
                            // In a real implementation, this would parse the texture format
                            // For now, we'll create a placeholder canvas
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = 'green';
                            ctx.fillRect(0, 0, 256, 256);
                            ctx.fillStyle = 'black';
                            ctx.font = '20px Arial';
                            ctx.fillText('DTX Texture', 70, 128);
                            
                            resolve({
                                type: 'texture',
                                canvas: canvas,
                                width: 256,
                                height: 256,
                                format: 'DTX',
                                metadata: {
                                    material: 'default',
                                    properties: {
                                        reflective: false,
                                        transparent: false
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing DTX file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // DAT Level Parser (simplified)
            parseDAT: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const buffer = e.target.result;
                            // In a real implementation, this would parse the level format
                            // using Kaitai Struct or similar
                            resolve({
                                type: 'level',
                                geometry: [],
                                entities: [],
                                navmesh: [],
                                metadata: {
                                    format: 'DAT',
                                    version: 1.0
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing DAT file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // REZ/LTA/PKB Archive Parser (improved)
            parseArchive: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const buffer = e.target.result;
                            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                            
                            // Determine archive format and parse accordingly
                            let files = [];
                            let format = '';
                            
                            if (fileExt === '.rez') {
                                // Parse REZ format (simplified)
                                format = 'REZ';
                                // REZ files typically have a header followed by a directory
                                const view = new DataView(buffer);
                                const signature = String.fromCharCode(
                                    view.getUint8(0),
                                    view.getUint8(1),
                                    view.getUint8(2),
                                    view.getUint8(3)
                                );
                                
                                if (signature !== 'REZF') {
                                    console.warn('Invalid REZ file signature');
                                }
                                
                                // Simulate parsing the directory - validate buffer sizes to prevent invalid typed array length errors
                                const bufferSize = buffer.byteLength;
                                const safeCreateDataView = (offset, size) => {
                                    // Make sure we don't try to create a view that exceeds the buffer
                                    const safeOffset = Math.min(offset, bufferSize - 1);
                                    const safeSize = Math.min(size, bufferSize - safeOffset);
                                    return new Uint8Array(buffer, safeOffset, safeSize);
                                };
                                
                                files = [
                                    { name: 'textures/character01.dtx', size: 1024, offset: 0, data: safeCreateDataView(0, 1024) },
                                    { name: 'models/character01.abc', size: 1024, offset: 1024, data: safeCreateDataView(1024, 1024) },
                                    { name: 'levels/level01.dat', size: 1024, offset: 2048, data: safeCreateDataView(2048, 1024) },
                                    { name: 'scripts/ai.lua', size: 1024, offset: 3072, data: safeCreateDataView(3072, 1024) }
                                ];
                            } else if (fileExt === '.lta' || fileExt === '.ltb') {
                                // Parse LTA/LTB format (simplified)
                                format = fileExt === '.lta' ? 'LTA' : 'LTB';
                                
                                // Simulate parsing with safe buffer access
                                const bufferSize = buffer.byteLength;
                                const safeCreateDataView = (offset, size) => {
                                    // Make sure we don't try to create a view that exceeds the buffer
                                    const safeOffset = Math.min(offset, bufferSize - 1);
                                    const safeSize = Math.min(size, bufferSize - safeOffset);
                                    return new Uint8Array(buffer, safeOffset, safeSize);
                                };
                                
                                files = [
                                    { name: 'section1.data', size: 1024, offset: 0, data: safeCreateDataView(0, 1024) },
                                    { name: 'section2.data', size: 1024, offset: 1024, data: safeCreateDataView(1024, 1024) },
                                    { name: 'section3.data', size: 1024, offset: 2048, data: safeCreateDataView(2048, 1024) }
                                ];
                            } else if (fileExt === '.pkb') {
                                // Parse PKB format (simplified for Matrix Online)
                                format = 'PKB';
                                const view = new DataView(buffer);
                                
                                // Check for LTMP header
                                const signature = String.fromCharCode(
                                    view.getUint8(0),
                                    view.getUint8(1),
                                    view.getUint8(2),
                                    view.getUint8(3)
                                );
                                
                                if (signature !== 'LTMP') {
                                    console.warn('Invalid PKB file signature');
                                }
                                
                                // Parse file count (at offset 0x10)
                                const fileCount = view.getUint32(16, true);
                                
                                // Simulate parsing the directory with safe buffer access
                                // In a real implementation, this would loop through the file entries
                                const bufferSize = buffer.byteLength;
                                const safeCreateDataView = (offset, size) => {
                                    // Make sure we don't try to create a view that exceeds the buffer
                                    const safeOffset = Math.min(offset, bufferSize - 1);
                                    const safeSize = Math.min(size, bufferSize - safeOffset);
                                    return new Uint8Array(buffer, safeOffset, safeSize);
                                };
                                
                                files = [
                                    { name: 'texture01.dtx', size: 1024, offset: 0, data: safeCreateDataView(0, 1024) },
                                    { name: 'model01.abc', size: 1024, offset: 1024, data: safeCreateDataView(1024, 1024) },
                                    { name: 'sound01.wav', size: 1024, offset: 2048, data: safeCreateDataView(2048, 1024) }
                                ];
                            }
                            
                            resolve({
                                type: 'archive',
                                files: files,
                                rawBuffer: buffer,
                                metadata: {
                                    format: format,
                                    version: 1.0,
                                    fileCount: files.length,
                                    totalSize: buffer.byteLength
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing archive file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // Message Parser (simplified)
            parseMessage: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            // For MSG files, we'll just treat them as text
                            const text = e.target.result;
                            resolve({
                                type: 'message',
                                content: text,
                                metadata: {
                                    format: 'MSG',
                                    version: 1.0
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing MSG file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            },
            
            // Assembly (DLL/EXE) Parser
            parseAssembly: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const buffer = e.target.result;
                            const view = new DataView(buffer);
                            
                            // Check for PE header (MZ signature)
                            const mzSignature = view.getUint16(0, true);
                            if (mzSignature !== 0x5A4D) { // 'MZ' in little-endian
                                console.warn('Not a valid PE file, missing MZ header');
                                reject(new Error('Invalid PE file format'));
                                return;
                            }
                            
                            // Get PE header offset (at 0x3C)
                            const peOffset = view.getUint32(0x3C, true);
                            
                            // Check for PE signature
                            const peSignature = view.getUint32(peOffset, true);
                            if (peSignature !== 0x4550) { // 'PE\0\0' in little-endian
                                console.warn('Not a valid PE file, missing PE signature');
                                reject(new Error('Invalid PE file format'));
                                return;
                            }
                            
                            // Parse basic PE information
                            const machine = view.getUint16(peOffset + 4, true);
                            const numberOfSections = view.getUint16(peOffset + 6, true);
                            const timeDateStamp = view.getUint32(peOffset + 8, true);
                            const characteristics = view.getUint16(peOffset + 22, true);
                            
                            // Check if it's a DLL
                            const isDll = (characteristics & 0x2000) !== 0;
                            
                            // Parse sections (simplified)
                            const sections = [];
                            const sectionHeadersOffset = peOffset + 24 + view.getUint16(peOffset + 20, true);
                            
                            for (let i = 0; i < numberOfSections; i++) {
                                const sectionOffset = sectionHeadersOffset + i * 40;
                                
                                // Read section name (8 bytes)
                                let name = '';
                                for (let j = 0; j < 8; j++) {
                                    const char = view.getUint8(sectionOffset + j);
                                    if (char === 0) break;
                                    name += String.fromCharCode(char);
                                }
                                
                                const virtualSize = view.getUint32(sectionOffset + 8, true);
                                const virtualAddress = view.getUint32(sectionOffset + 12, true);
                                const rawDataSize = view.getUint32(sectionOffset + 16, true);
                                const rawDataOffset = view.getUint32(sectionOffset + 20, true);
                                
                                sections.push({
                                    name,
                                    virtualSize,
                                    virtualAddress,
                                    rawDataSize,
                                    rawDataOffset
                                });
                            }
                            
                            // Extract imported functions (simplified)
                            const imports = [
                                { dll: 'kernel32.dll', functions: ['CreateFileA', 'ReadFile', 'WriteFile', 'CloseHandle'] },
                                { dll: 'user32.dll', functions: ['MessageBoxA', 'ShowWindow', 'RegisterClassA'] },
                                { dll: 'gdi32.dll', functions: ['CreateDC', 'BitBlt', 'DeleteDC'] }
                            ];
                            
                            // Extract exported functions (simplified)
                            const exports = [
                                { name: 'Initialize', ordinal: 1 },
                                { name: 'Shutdown', ordinal: 2 },
                                { name: 'Process', ordinal: 3 }
                            ];
                            
                            resolve({
                                type: 'assembly',
                                machine: machine,
                                isDll: isDll,
                                timestamp: new Date(timeDateStamp * 1000).toISOString(),
                                sections: sections,
                                imports: imports,
                                exports: exports,
                                rawBuffer: buffer,
                                metadata: {
                                    format: 'PE',
                                    is64Bit: machine === 0x8664, // 0x8664 = AMD64
                                    isManagedCode: false, // would require checking for CLR header
                                    characteristics: characteristics
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing assembly file:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
        };
        
        // Component: File Tree
        const FileTree = ({ files, onFileSelect, selectedFile }) => {
            const [expandedFolders, setExpandedFolders] = useState({});
            
            const toggleFolder = (path) => {
                setExpandedFolders({
                    ...expandedFolders,
                    [path]: !expandedFolders[path]
                });
            };
            
            // Recursive function to render file tree
            const renderTree = (items, path = '') => {
                return Object.keys(items).map(key => {
                    const currentPath = path ? `${path}/${key}` : key;
                    const item = items[key];
                    
                    if (item.type === 'folder') {
                        const isExpanded = expandedFolders[currentPath] !== false;
                        return (
                            <div key={currentPath}>
                                <div 
                                    className="file-tree-item file-tree-folder"
                                    onClick={() => toggleFolder(currentPath)}
                                >
                                    <span>{isExpanded ? '📂' : '📁'} {key}</span>
                                </div>
                                {isExpanded && item.children && (
                                    <div style={{ paddingLeft: '20px' }}>
                                        {renderTree(item.children, currentPath)}
                                    </div>
                                )}
                            </div>
                        );
                    } else {
                        const fileType = getFileType(key);
                        const isSelected = selectedFile === currentPath;
                        return (
                            <div 
                                key={currentPath}
                                className={`file-tree-item ${isSelected ? 'selected' : ''}`}
                                onClick={() => onFileSelect(currentPath, item)}
                            >
                                <span>{fileType.icon} {key}</span>
                            </div>
                        );
                    }
                });
            };
            
            return (
                <div className="file-tree p-2">
                    <h3 className="matrix-title text-sm">Files</h3>
                    {files && Object.keys(files).length > 0 ? (
                        renderTree(files)
                    ) : (
                        <div className="p-4 text-sm">
                            No files loaded. Use the "Load Directory" button above.
                        </div>
                    )}
                </div>
            );
        };
        
        // Component: Model Editor
        const ModelEditor = ({ file, data }) => {
            const containerRef = useRef(null);
            const [scene, setScene] = useState(null);
            const [activeTab, setActiveTab] = useState(data?.initialTab || 'view');
            const [renderMode, setRenderMode] = useState('solid');
            const [showBones, setShowBones] = useState(false);
            const [showAxes, setShowAxes] = useState(true);
            const [animationPlaying, setAnimationPlaying] = useState(false);
            const [currentAnimation, setCurrentAnimation] = useState(0);
            const [modelStats, setModelStats] = useState({
                vertices: 0,
                faces: 0,
                bones: 0,
                animations: 0
            });
            const rendererRef = useRef(null);
            const controlsRef = useRef(null);
            const modelRef = useRef(null);
            const mixerRef = useRef(null);
            
            useEffect(() => {
                if (!containerRef.current) return;
                
                // Initialize Three.js
                const width = containerRef.current.clientWidth;
                const height = containerRef.current.clientHeight;
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                
                renderer.setSize(width, height);
                renderer.setClearColor(0x001a00, 1);
                containerRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;
                
                // Add controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.25;
                controlsRef.current = controls;
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // Add axes helper
                const axesHelper = new THREE.AxesHelper(5);
                scene.add(axesHelper);
                
                // Add a grid
                const gridHelper = new THREE.GridHelper(10, 10, 0x00ff00, 0x004400);
                scene.add(gridHelper);
                
                // Check if we have actual model data, otherwise use placeholder
                if (data && data.type === 'model' && data.vertices && data.vertices.length > 0) {
                    // Create a geometry from the parsed data
                    const geometry = new THREE.BufferGeometry();
                    
                    // Add vertices
                    if (data.vertices.length > 0) {
                        const vertices = new Float32Array(data.vertices);
                        geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
                    }
                    
                    // Add UVs if available
                    if (data.uvs && data.uvs.length > 0) {
                        const uvs = new Float32Array(data.uvs);
                        geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
                    }
                    
                    // Add normals if available
                    if (data.normals && data.normals.length > 0) {
                        const normals = new Float32Array(data.normals);
                        geometry.setAttribute('normal', new THREE.BufferAttribute(normals, 3));
                    } else {
                        // Compute normals if not provided
                        geometry.computeVertexNormals();
                    }
                    
                    // Add indices if available
                    if (data.indices && data.indices.length > 0) {
                        geometry.setIndex(data.indices);
                    }
                    
                    // Create material
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0x00ff00,
                        wireframe: false,
                        side: THREE.DoubleSide
                    });
                    
                    // Create mesh
                    const mesh = new THREE.Mesh(geometry, material);
                    scene.add(mesh);
                    modelRef.current = mesh;
                    
                    // Calculate statistics
                    setModelStats({
                        vertices: data.vertices.length / 3,
                        faces: data.indices ? data.indices.length / 3 : data.vertices.length / 9,
                        bones: data.bones ? data.bones.length : 0,
                        animations: data.animations ? data.animations.length : 0
                    });
                    
                    // Add animations if available
                    if (data.animations && data.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(mesh);
                        mixerRef.current = mixer;
                        
                        // Convert animations to THREE.js format
                        // (simplified - in a real implementation this would parse the actual animation data)
                        const clip = THREE.AnimationClip.parseAnimation({
                            hierarchy: [{
                                keys: [
                                    { time: 0, pos: [0, 0, 0], rot: [0, 0, 0, 1], scl: [1, 1, 1] },
                                    { time: 1, pos: [0, 1, 0], rot: [0, 0, 0, 1], scl: [1, 1, 1] },
                                    { time: 2, pos: [0, 0, 0], rot: [0, 0, 0, 1], scl: [1, 1, 1] }
                                ]
                            }]
                        }, data.bones || []);
                        
                        mixer.clipAction(clip).play();
                    }
                } else {
                    // Add a placeholder model (character-like figure)
                    const characterGroup = new THREE.Group();
                    
                    // Body
                    const bodyGeometry = new THREE.CapsuleGeometry(0.5, 1.5, 4, 8);
                    const bodyMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x00ff00,
                        wireframe: renderMode === 'wireframe'
                    });
                    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                    body.position.y = 1.5;
                    characterGroup.add(body);
                    
                    // Head
                    const headGeometry = new THREE.SphereGeometry(0.4, 16, 16);
                    const headMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x00ff00,
                        wireframe: renderMode === 'wireframe' 
                    });
                    const head = new THREE.Mesh(headGeometry, headMaterial);
                    head.position.y = 2.8;
                    characterGroup.add(head);
                    
                    // Arms
                    const armGeometry = new THREE.CapsuleGeometry(0.2, 1, 4, 8);
                    const armMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x00ff00,
                        wireframe: renderMode === 'wireframe'
                    });
                    
                    const rightArm = new THREE.Mesh(armGeometry, armMaterial);
                    rightArm.position.set(0.8, 1.8, 0);
                    rightArm.rotation.z = Math.PI / 2.5;
                    characterGroup.add(rightArm);
                    
                    const leftArm = new THREE.Mesh(armGeometry, armMaterial);
                    leftArm.position.set(-0.8, 1.8, 0);
                    leftArm.rotation.z = -Math.PI / 2.5;
                    characterGroup.add(leftArm);
                    
                    // Legs
                    const legGeometry = new THREE.CapsuleGeometry(0.25, 1.2, 4, 8);
                    const legMaterial = new THREE.MeshPhongMaterial({ 
                        color: 0x00ff00,
                        wireframe: renderMode === 'wireframe'
                    });
                    
                    const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
                    rightLeg.position.set(0.3, 0.6, 0);
                    characterGroup.add(rightLeg);
                    
                    const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
                    leftLeg.position.set(-0.3, 0.6, 0);
                    characterGroup.add(leftLeg);
                    
                    scene.add(characterGroup);
                    modelRef.current = characterGroup;
                    
                    // Set mock stats
                    setModelStats({
                        vertices: 1024,
                        faces: 512,
                        bones: 16,
                        animations: 5
                    });
                    
                    // Add mock animation mixer
                    const mixer = new THREE.AnimationMixer(characterGroup);
                    mixerRef.current = mixer;
                    
                    // Mock animation for the character
                    const idleAnimation = {
                        name: 'idle',
                        duration: 2,
                        update: (time) => {
                            const t = time % 2;
                            const y = Math.sin(t * Math.PI) * 0.1;
                            characterGroup.position.y = y;
                            
                            // Breathe effect
                            const scale = 1 + Math.sin(t * Math.PI) * 0.02;
                            body.scale.set(1, scale, 1);
                            
                            // Arm swing
                            rightArm.rotation.z = Math.PI / 2.5 + Math.sin(t * Math.PI) * 0.1;
                            leftArm.rotation.z = -Math.PI / 2.5 - Math.sin(t * Math.PI) * 0.1;
                        }
                    };
                    
                    // Store animation
                    characterGroup.userData.animations = [idleAnimation];
                }
                
                // Position camera
                camera.position.set(0, 2, 5);
                camera.lookAt(0, 1, 0);
                
                // Animation clock
                const clock = new THREE.Clock();
                
                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Update controls
                    if (controlsRef.current) {
                        controlsRef.current.update();
                    }
                    
                    // Update animations
                    const delta = clock.getDelta();
                    
                    if (mixerRef.current && animationPlaying) {
                        mixerRef.current.update(delta);
                    }
                    
                    // For mock animations
                    if (modelRef.current && 
                        modelRef.current.userData && 
                        modelRef.current.userData.animations && 
                        animationPlaying) {
                        const anim = modelRef.current.userData.animations[currentAnimation];
                        if (anim && anim.update) {
                            anim.update(clock.elapsedTime);
                        }
                    }
                    
                    // Render
                    renderer.render(scene, camera);
                };
                
                animate();
                setScene(scene);
                
                // Handle window resize
                const handleResize = () => {
                    const width = containerRef.current.clientWidth;
                    const height = containerRef.current.clientHeight;
                    
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    
                    renderer.setSize(width, height);
                };
                
                window.addEventListener('resize', handleResize);
                
                // Cleanup on unmount
                return () => {
                    window.removeEventListener('resize', handleResize);
                    
                    if (containerRef.current && containerRef.current.contains(renderer.domElement)) {
                        containerRef.current.removeChild(renderer.domElement);
                    }
                    
                    renderer.dispose();
                    if (mixerRef.current) {
                        mixerRef.current.stopAllAction();
                    }
                };
            }, [containerRef, data, renderMode, showAxes]);
            
            // Toggle wireframe mode
            const toggleRenderMode = () => {
                const newMode = renderMode === 'solid' ? 'wireframe' : 'solid';
                setRenderMode(newMode);
                
                // Update materials on the model
                if (modelRef.current) {
                    modelRef.current.traverse((child) => {
                        if (child.isMesh) {
                            child.material.wireframe = newMode === 'wireframe';
                        }
                    });
                }
            };
            
            // Toggle animation playback
            const toggleAnimation = () => {
                setAnimationPlaying(!animationPlaying);
                
                if (mixerRef.current) {
                    if (!animationPlaying) {
                        // Resume animation
                        mixerRef.current.timeScale = 1;
                    } else {
                        // Pause animation
                        mixerRef.current.timeScale = 0;
                    }
                }
            };
            
            // Change animation
            const changeAnimation = (index) => {
                setCurrentAnimation(index);
                
                if (mixerRef.current) {
                    mixerRef.current.stopAllAction();
                    
                    // In a real implementation, we would play the selected animation
                    // This is simplified for the demo
                    if (animationPlaying) {
                        // Placeholder for animation switching
                        console.log(`Switched to animation ${index}`);
                    }
                }
            };
            
            // Toggle axes visibility
            const toggleAxes = () => {
                setShowAxes(!showAxes);
                
                if (scene) {
                    scene.children.forEach(child => {
                        if (child.isAxesHelper) {
                            child.visible = !showAxes;
                        }
                    });
                }
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Model Editor: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button className="matrix-button m-2 text-xs">Save</button>
                        </div>
                    </div>
                    
                    {/* Tabs */}
                    <div className="border-b border-green-900">
                        <div className="flex">
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'view' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('view')}
                            >
                                3D View
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'animation' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('animation')}
                            >
                                Animation
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'info' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('info')}
                            >
                                Info
                            </div>
                        </div>
                    </div>
                    
                    {activeTab === 'view' && (
                        <div className="relative" style={{ height: 'calc(100% - 80px)' }}>
                            <div 
                                ref={containerRef} 
                                className="webgl-container"
                                style={{ height: '100%' }}
                            ></div>
                            
                            <div className="absolute top-4 right-4 bg-black bg-opacity-50 p-2 rounded">
                                <button 
                                    className="matrix-button mb-2 text-xs w-full"
                                    onClick={toggleRenderMode}
                                >
                                    {renderMode === 'solid' ? 'Wireframe' : 'Solid'}
                                </button>
                                <button 
                                    className="matrix-button mb-2 text-xs w-full"
                                    onClick={toggleAxes}
                                >
                                    {showAxes ? 'Hide Axes' : 'Show Axes'}
                                </button>
                                <button 
                                    className="matrix-button text-xs w-full"
                                    onClick={toggleAnimation}
                                >
                                    {animationPlaying ? 'Pause' : 'Animate'}
                                </button>
                            </div>
                            
                            <div className="absolute bottom-4 left-4 text-xs">
                                <p>Left click + drag: Rotate</p>
                                <p>Right click + drag: Pan</p>
                                <p>Scroll: Zoom</p>
                            </div>
                        </div>
                    )}
                    
                    {activeTab === 'animation' && (
                        <div className="p-4" style={{ height: 'calc(100% - 80px)', overflowY: 'auto' }}>
                            <h4 className="text-sm font-bold mb-4">Animation Controls</h4>
                            
                            <div className="mb-6">
                                <button 
                                    className={`matrix-button m-2 ${animationPlaying ? 'bg-red-900' : ''}`}
                                    onClick={toggleAnimation}
                                >
                                    {animationPlaying ? 'Stop Animation' : 'Play Animation'}
                                </button>
                            </div>
                            
                            <h4 className="text-sm font-bold mb-2">Available Animations</h4>
                            <div className="grid grid-cols-1 gap-2">
                                {['Idle', 'Walk', 'Run', 'Jump', 'Attack'].map((anim, index) => (
                                    <div 
                                        key={index}
                                        className={`p-2 cursor-pointer border ${
                                            currentAnimation === index ? 'border-green-500 bg-green-900 bg-opacity-20' : 'border-gray-700'
                                        }`}
                                        onClick={() => changeAnimation(index)}
                                    >
                                        <p className="font-bold">{anim}</p>
                                        <p className="text-xs">Duration: {(index + 1) * 0.5}s</p>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="mt-8 p-4 bg-black bg-opacity-20">
                                <h4 className="text-sm font-bold mb-2">Animation Blending</h4>
                                <p className="text-xs mb-4">
                                    Adjust the blending between animations for smooth transitions.
                                </p>
                                
                                <div className="mb-2">
                                    <label className="text-xs block mb-1">Blend Factor</label>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="1" 
                                        step="0.01" 
                                        defaultValue="0.5"
                                        className="w-full"
                                    />
                                </div>
                                
                                <div className="mb-2">
                                    <label className="text-xs block mb-1">Transition Duration</label>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="2" 
                                        step="0.1" 
                                        defaultValue="0.5"
                                        className="w-full"
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {activeTab === 'info' && (
                        <div className="p-4" style={{ height: 'calc(100% - 80px)', overflowY: 'auto' }}>
                            <h4 className="text-sm font-bold mb-4">Model Information</h4>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-black bg-opacity-20 p-4 rounded">
                                    <h5 className="text-sm font-bold mb-2">Geometry</h5>
                                    <p className="text-xs"><strong>Vertices:</strong> {modelStats.vertices}</p>
                                    <p className="text-xs"><strong>Faces:</strong> {modelStats.faces}</p>
                                    <p className="text-xs"><strong>Bones:</strong> {modelStats.bones}</p>
                                </div>
                                
                                <div className="bg-black bg-opacity-20 p-4 rounded">
                                    <h5 className="text-sm font-bold mb-2">Animation</h5>
                                    <p className="text-xs"><strong>Animations:</strong> {modelStats.animations}</p>
                                    <p className="text-xs"><strong>Format:</strong> {file.name.endsWith('.abc') ? 'Lithtech ABC' : 'Matrix Online MOB'}</p>
                                </div>
                            </div>
                            
                            <h4 className="text-sm font-bold mb-2">Matrix Online Model Format</h4>
                            <p className="text-xs mb-4">
                                {file.name.endsWith('.abc') ? (
                                    <>
                                        ABC (Actor Binary Cache) files store 3D models used in The Matrix Online. 
                                        They contain meshes, skeletons, animations, and material definitions.
                                        These files are optimized for the Lithtech Jupiter engine.
                                    </>
                                ) : (
                                    <>
                                        MOB (Matrix Online Binary) files are specialized model files for The Matrix Online.
                                        They contain character models, equipment, and props used in the game world.
                                    </>
                                )}
                            </p>
                            
                            <h4 className="text-sm font-bold mb-2 mt-6">Technical Details</h4>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <tbody>
                                    <tr>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>File Size</td>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                            {file.size} bytes
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Mesh Count</td>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                            1
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Material Count</td>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                            1
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>UV Channels</td>
                                        <td style={{ padding: '4px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                            1
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };
        
        // Component: Texture Editor
        const TextureEditor = ({ file, data }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current || !data || !data.canvas) return;
                
                const context = canvasRef.current.getContext('2d');
                
                // Copy from the data canvas to our display canvas
                canvasRef.current.width = data.width;
                canvasRef.current.height = data.height;
                context.drawImage(data.canvas, 0, 0);
                
            }, [canvasRef, data]);
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Texture Editor: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button className="matrix-button m-2 text-xs">Save</button>
                        </div>
                    </div>
                    <div className="p-4 flex items-center justify-center" style={{ height: 'calc(100% - 40px)' }}>
                        <canvas 
                            ref={canvasRef} 
                            style={{ 
                                maxWidth: '100%', 
                                maxHeight: '100%', 
                                border: '1px solid #00ff00' 
                            }}
                        ></canvas>
                    </div>
                </div>
            );
        };
        
        // Component: Level Editor
        const LevelEditor = ({ file, data }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (!containerRef.current) return;
                
                // Initialize Three.js for level editing
                const width = containerRef.current.clientWidth;
                const height = containerRef.current.clientHeight;
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                
                renderer.setSize(width, height);
                renderer.setClearColor(0x001a00, 1);
                containerRef.current.appendChild(renderer.domElement);
                
                // Add controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // Add a placeholder level grid
                const gridHelper = new THREE.GridHelper(100, 100, 0x00ff00, 0x004400);
                scene.add(gridHelper);
                
                // Add placeholder level geometry
                const geometry = new THREE.BoxGeometry(10, 1, 10);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0x00ff00,
                    wireframe: false
                });
                const platform = new THREE.Mesh(geometry, material);
                platform.position.y = -0.5;
                scene.add(platform);
                
                // Position camera
                camera.position.set(10, 10, 10);
                camera.lookAt(0, 0, 0);
                
                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                
                animate();
                
                // Cleanup on unmount
                return () => {
                    if (containerRef.current && containerRef.current.contains(renderer.domElement)) {
                        containerRef.current.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                };
            }, [containerRef, data]);
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Level Editor: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button className="matrix-button m-2 text-xs">Save</button>
                        </div>
                    </div>
                    <div 
                        ref={containerRef} 
                        className="webgl-container"
                        style={{ height: 'calc(100% - 40px)' }}
                    ></div>
                </div>
            );
        };
        
        // Component: Text Editor (for scripts, messages, etc.)
        const TextEditor = ({ file, data, onSave }) => {
            const containerRef = useRef(null);
            const editorRef = useRef(null);
            const [content, setContent] = useState('');
            
            useEffect(() => {
                if (!containerRef.current) return;
                
                // Initialize Monaco Editor
                require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' }});
                require(['vs/editor/editor.main'], () => {
                    if (editorRef.current) {
                        editorRef.current.dispose();
                    }
                    
                    // Determine language based on file extension
                    let language = 'plaintext';
                    if (file.name.endsWith('.lua')) language = 'lua';
                    else if (file.name.endsWith('.cs')) language = 'csharp';
                    else if (file.name.endsWith('.xml')) language = 'xml';
                    else if (file.name.endsWith('.json')) language = 'json';
                    
                    // Set initial content
                    let initialContent = '';
                    if (data && data.content) {
                        initialContent = data.content;
                    } else if (typeof data === 'string') {
                        initialContent = data;
                    }
                    
                    setContent(initialContent);
                    
                    // Create editor
                    editorRef.current = monaco.editor.create(containerRef.current, {
                        value: initialContent,
                        language: language,
                        theme: 'vs-dark',
                        minimap: { enabled: true },
                        automaticLayout: true,
                        fontSize: 14,
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false,
                        roundedSelection: false,
                        readOnly: false,
                        cursorStyle: 'line',
                        selectOnLineNumbers: true,
                        wordWrap: 'on'
                    });
                    
                    // Update content state when editor changes
                    editorRef.current.onDidChangeModelContent(() => {
                        setContent(editorRef.current.getValue());
                    });
                });
                
                return () => {
                    if (editorRef.current) {
                        editorRef.current.dispose();
                    }
                };
            }, [containerRef, file, data]);
            
            const handleSave = () => {
                if (onSave && editorRef.current) {
                    onSave(editorRef.current.getValue());
                }
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Text Editor: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs" onClick={handleSave}>Save</button>
                        </div>
                    </div>
                    <div 
                        ref={containerRef} 
                        className="monaco-editor"
                        style={{ height: 'calc(100% - 40px)' }}
                    ></div>
                </div>
            );
        };
        
        // Component: Audio Editor
        const AudioEditor = ({ file, data }) => {
            const audioRef = useRef(null);
            const canvasRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [activeTab, setActiveTab] = useState('waveform');
            const [audioMetadata, setAudioMetadata] = useState(null);
            
            useEffect(() => {
                if (!audioRef.current || !canvasRef.current) return;
                
                // Set up audio visualization
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const canvas = canvasRef.current;
                const canvasCtx = canvas.getContext('2d');
                
                const source = audioContext.createMediaElementSource(audioRef.current);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // Get audio metadata when loaded
                audioRef.current.onloadedmetadata = () => {
                    setAudioMetadata({
                        duration: audioRef.current.duration,
                        sampleRate: audioContext.sampleRate,
                        channels: 2, // Assuming stereo
                        format: file.name.split('.').pop().toUpperCase()
                    });
                };
                
                function draw() {
                    const WIDTH = canvas.width;
                    const HEIGHT = canvas.height;
                    
                    requestAnimationFrame(draw);
                    
                    analyser.getByteTimeDomainData(dataArray);
                    
                    canvasCtx.fillStyle = 'rgb(0, 26, 0)';
                    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
                    
                    canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'rgb(0, 255, 0)';
                    
                    canvasCtx.beginPath();
                    
                    const sliceWidth = WIDTH * 1.0 / bufferLength;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * HEIGHT / 2;
                        
                        if (i === 0) {
                            canvasCtx.moveTo(x, y);
                        } else {
                            canvasCtx.lineTo(x, y);
                        }
                        
                        x += sliceWidth;
                    }
                    
                    canvasCtx.lineTo(canvas.width, canvas.height / 2);
                    canvasCtx.stroke();
                }
                
                draw();
                
                return () => {
                    if (audioContext.state !== 'closed') {
                        audioContext.close();
                    }
                };
            }, [audioRef, canvasRef, file]);
            
            const togglePlay = () => {
                if (audioRef.current) {
                    if (isPlaying) {
                        audioRef.current.pause();
                    } else {
                        audioRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Audio Editor: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button className="matrix-button m-2 text-xs">Save</button>
                        </div>
                    </div>
                    
                    {/* Tabs */}
                    <div className="border-b border-green-900">
                        <div className="flex">
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'waveform' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('waveform')}
                            >
                                Waveform
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'spectrum' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('spectrum')}
                            >
                                Spectrum
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'metadata' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('metadata')}
                            >
                                Metadata
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-4" style={{ height: 'calc(100% - 80px)', overflowY: 'auto' }}>
                        {activeTab === 'waveform' && (
                            <div className="flex flex-col items-center justify-center">
                                <canvas 
                                    ref={canvasRef}
                                    width="600"
                                    height="200"
                                    style={{ 
                                        width: '100%', 
                                        maxWidth: '600px',
                                        border: '1px solid #00ff00' 
                                    }}
                                ></canvas>
                                
                                <div className="flex items-center justify-center mt-4 mb-2">
                                    <button 
                                        className="matrix-button m-2"
                                        onClick={togglePlay}
                                    >
                                        {isPlaying ? 'Pause' : 'Play'}
                                    </button>
                                </div>
                                
                                <audio 
                                    ref={audioRef}
                                    src={data ? data.url : ''}
                                    onEnded={() => setIsPlaying(false)}
                                    controls
                                    style={{ 
                                        width: '100%',
                                        maxWidth: '600px',
                                        marginTop: '20px',
                                        backgroundColor: '#001a00',
                                        borderRadius: '3px'
                                    }}
                                ></audio>
                            </div>
                        )}
                        
                        {activeTab === 'spectrum' && (
                            <div className="flex flex-col items-center justify-center">
                                <p className="mb-4 text-center">Frequency Spectrum Analysis</p>
                                <div
                                    style={{
                                        width: '100%',
                                        maxWidth: '600px',
                                        height: '200px',
                                        backgroundColor: '#001a00',
                                        border: '1px solid #00ff00',
                                        position: 'relative'
                                    }}
                                >
                                    {/* Simulated frequency bars */}
                                    {Array.from({ length: 32 }).map((_, i) => {
                                        const height = Math.random() * 70 + 10;
                                        return (
                                            <div
                                                key={i}
                                                style={{
                                                    position: 'absolute',
                                                    bottom: '0',
                                                    left: `${i * 3}%`,
                                                    width: '2%',
                                                    height: `${height}%`,
                                                    backgroundColor: '#00ff00',
                                                    opacity: '0.7'
                                                }}
                                            ></div>
                                        );
                                    })}
                                </div>
                                
                                <div className="mt-4 text-center text-sm">
                                    <p>Frequency (Hz)</p>
                                    <div className="flex justify-between w-full max-w-[600px] mt-2">
                                        <span>20</span>
                                        <span>100</span>
                                        <span>500</span>
                                        <span>1k</span>
                                        <span>5k</span>
                                        <span>10k</span>
                                        <span>20k</span>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'metadata' && (
                            <div className="w-full max-w-[600px] mx-auto">
                                <h4 className="text-sm font-bold mb-4">Audio File Information</h4>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <tbody>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Filename</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {file.name}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Format</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {audioMetadata?.format || file.name.split('.').pop().toUpperCase()}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Duration</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {audioMetadata?.duration ? `${audioMetadata.duration.toFixed(2)} seconds` : 'Unknown'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Sample Rate</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {audioMetadata?.sampleRate ? `${audioMetadata.sampleRate} Hz` : 'Unknown'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Channels</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {audioMetadata?.channels || 'Unknown'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>File Size</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {file.size} bytes
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <h4 className="text-sm font-bold mt-6 mb-4">Matrix Online Context</h4>
                                <p className="text-sm mb-4">
                                    Audio files in Matrix Online are typically used for:
                                </p>
                                <ul className="text-sm list-disc pl-5">
                                    <li className="mb-2">Character dialog and voice lines</li>
                                    <li className="mb-2">Environmental sound effects</li>
                                    <li className="mb-2">User interface sounds</li>
                                    <li className="mb-2">Background music and ambient audio</li>
                                </ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // Component: Cutscene Player
        const CutscenePlayer = ({ file, data }) => {
            const videoRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [videoMetadata, setVideoMetadata] = useState(null);
            
            useEffect(() => {
                if (!videoRef.current) return;
                
                const video = videoRef.current;
                
                // Get video metadata when loaded
                video.onloadedmetadata = () => {
                    setDuration(video.duration);
                    setVideoMetadata({
                        duration: video.duration,
                        width: video.videoWidth,
                        height: video.videoHeight,
                        format: file.name.split('.').pop().toUpperCase()
                    });
                };
                
                // Update current time during playback
                video.ontimeupdate = () => {
                    setCurrentTime(video.currentTime);
                };
                
                // Handle playback end
                video.onended = () => {
                    setIsPlaying(false);
                };
                
                return () => {
                    // Clean up event listeners
                    video.onloadedmetadata = null;
                    video.ontimeupdate = null;
                    video.onended = null;
                };
            }, [videoRef, file]);
            
            const togglePlay = () => {
                if (videoRef.current) {
                    if (isPlaying) {
                        videoRef.current.pause();
                    } else {
                        videoRef.current.play();
                    }
                    setIsPlaying(!isPlaying);
                }
            };
            
            const handleSeek = (e) => {
                if (!videoRef.current || !duration) return;
                
                const seekPosition = parseFloat(e.target.value);
                videoRef.current.currentTime = seekPosition;
                setCurrentTime(seekPosition);
            };
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Cutscene Player: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button className="matrix-button m-2 text-xs">Extract Frames</button>
                        </div>
                    </div>
                    
                    <div className="p-4 flex flex-col items-center" style={{ height: 'calc(100% - 40px)', overflowY: 'auto' }}>
                        <div className="relative w-full max-w-[800px]" style={{ backgroundColor: '#000', aspectRatio: '16/9' }}>
                            <video
                                ref={videoRef}
                                src={data ? data.url : ''}
                                style={{ 
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'contain'
                                }}
                                onClick={togglePlay}
                            ></video>
                            
                            {!isPlaying && (
                                <div 
                                    className="absolute inset-0 flex items-center justify-center cursor-pointer"
                                    onClick={togglePlay}
                                >
                                    <div className="w-16 h-16 bg-green-800 bg-opacity-70 rounded-full flex items-center justify-center">
                                        <div className="w-0 h-0 border-t-8 border-b-8 border-l-16 border-transparent border-l-green-300 ml-2"></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="w-full max-w-[800px] mt-4">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm">{formatTime(currentTime)}</span>
                                <span className="text-sm">{formatTime(duration)}</span>
                            </div>
                            
                            <input
                                type="range"
                                min="0"
                                max={duration || 100}
                                value={currentTime}
                                onChange={handleSeek}
                                className="w-full"
                                style={{
                                    height: '4px',
                                    appearance: 'none',
                                    backgroundColor: '#001a00',
                                    outline: 'none',
                                    borderRadius: '2px',
                                    cursor: 'pointer'
                                }}
                            />
                            
                            <div className="flex items-center justify-center mt-4">
                                <button 
                                    className="matrix-button mx-2"
                                    onClick={() => {
                                        if (videoRef.current) {
                                            videoRef.current.currentTime = Math.max(0, videoRef.current.currentTime - 10);
                                        }
                                    }}
                                >
                                    -10s
                                </button>
                                
                                <button 
                                    className="matrix-button mx-2"
                                    onClick={togglePlay}
                                >
                                    {isPlaying ? 'Pause' : 'Play'}
                                </button>
                                
                                <button 
                                    className="matrix-button mx-2"
                                    onClick={() => {
                                        if (videoRef.current) {
                                            videoRef.current.currentTime = Math.min(
                                                videoRef.current.duration,
                                                videoRef.current.currentTime + 10
                                            );
                                        }
                                    }}
                                >
                                    +10s
                                </button>
                            </div>
                        </div>
                        
                        {videoMetadata && (
                            <div className="w-full max-w-[800px] mt-8 p-4" style={{ backgroundColor: 'rgba(0, 255, 0, 0.1)', borderRadius: '5px' }}>
                                <h4 className="text-sm font-bold mb-2">Video Information</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm mb-1"><strong>Format:</strong> {videoMetadata.format}</p>
                                        <p className="text-sm mb-1"><strong>Duration:</strong> {formatTime(videoMetadata.duration)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm mb-1"><strong>Resolution:</strong> {videoMetadata.width}x{videoMetadata.height}</p>
                                        <p className="text-sm mb-1"><strong>File Size:</strong> {file.size} bytes</p>
                                    </div>
                                </div>
                                
                                <p className="text-sm mt-4 mb-2">
                                    <strong>Matrix Online Cutscene:</strong> This video file contains in-game cinematics from The Matrix Online.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // Component: Archive Viewer
        const ArchiveViewer = ({ file, data, onFileExtracted }) => {
            const [selectedEntry, setSelectedEntry] = useState(null);
            const [extractionPath, setExtractionPath] = useState('./extracted');
            const [showExtractionDialog, setShowExtractionDialog] = useState(false);
            const [extractingFile, setExtractingFile] = useState(null);
            const [extractionProgress, setExtractionProgress] = useState(0);
            
            // Handle extraction of a single file
            const handleExtractFile = (entry, index) => {
                setSelectedEntry(index);
                setExtractingFile(entry);
                setShowExtractionDialog(true);
            };
            
            // Handle extraction of all files
            const handleExtractAll = () => {
                setExtractingFile(null); // Indicates we're extracting all files
                setShowExtractionDialog(true);
            };
            
            // Process file extraction
            const processExtraction = () => {
                setExtractionProgress(0);
                
                // Determine which files to extract
                const filesToExtract = extractingFile ? [extractingFile] : (data?.files || []);
                
                // Start extraction process
                let processed = 0;
                
                // Simulate extraction process
                const extractInterval = setInterval(() => {
                    processed++;
                    setExtractionProgress(Math.floor((processed / filesToExtract.length) * 100));
                    
                    // When finished
                    if (processed >= filesToExtract.length) {
                        clearInterval(extractInterval);
                        
                        // Create extracted file objects to add to the file system
                        const extractedFiles = filesToExtract.map(entry => {
                            // Create a File object from the array buffer
                            const blob = new Blob([entry.data], { type: getMimeType(entry.name) });
                            const file = new File([blob], entry.name, { 
                                type: getMimeType(entry.name), 
                                lastModified: new Date().getTime() 
                            });
                            
                            return {
                                path: `${extractionPath}/${entry.name}`,
                                file: file
                            };
                        });
                        
                        // Notify parent component about extracted files
                        if (onFileExtracted) {
                            onFileExtracted(extractedFiles);
                        }
                        
                        setShowExtractionDialog(false);
                        setExtractingFile(null);
                        
                        // Show success message
                        alert(`Successfully extracted ${filesToExtract.length} file(s) to ${extractionPath}`);
                    }
                }, 100);
            };
            
            // Helper function to get MIME type from filename
            const getMimeType = (filename) => {
                const ext = filename.split('.').pop().toLowerCase();
                const mimeTypes = {
                    'dtx': 'application/octet-stream',
                    'abc': 'application/octet-stream',
                    'dat': 'application/octet-stream',
                    'wav': 'audio/wav',
                    'mp3': 'audio/mpeg',
                    'ogg': 'audio/ogg',
                    'lua': 'text/plain',
                    'txt': 'text/plain',
                    'cs': 'text/plain',
                    'xml': 'text/xml',
                    'jpg': 'image/jpeg',
                    'png': 'image/png'
                };
                
                return mimeTypes[ext] || 'application/octet-stream';
            };
            
            // Preview selected file
            const previewFile = (entry, index) => {
                setSelectedEntry(index);
                
                const fileExt = '.' + entry.name.split('.').pop().toLowerCase();
                const fileType = getFileType(entry.name);
                
                if (FILE_TYPES.MODEL.extensions.includes(fileExt)) {
                    alert('Model preview not implemented in this demo');
                } else if (FILE_TYPES.TEXTURE.extensions.includes(fileExt)) {
                    alert('Texture preview not implemented in this demo');
                } else if (FILE_TYPES.SOUND.extensions.includes(fileExt)) {
                    // Create audio URL and play
                    const blob = new Blob([entry.data], { type: getMimeType(entry.name) });
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio.play();
                } else if (FILE_TYPES.SCRIPT.extensions.includes(fileExt) || 
                          FILE_TYPES.MESSAGE.extensions.includes(fileExt)) {
                    // Show text preview
                    const decoder = new TextDecoder('utf-8');
                    const text = decoder.decode(entry.data);
                    alert(`Preview of ${entry.name}:\n\n${text.substring(0, 500)}${text.length > 500 ? '...' : ''}`);
                } else {
                    alert(`Preview not available for ${entry.name}`);
                }
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Archive Viewer: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs" onClick={handleExtractAll}>Extract All</button>
                        </div>
                    </div>
                    <div className="p-4 overflow-auto" style={{ height: 'calc(100% - 40px)' }}>
                        {data && data.metadata && (
                            <div className="mb-4 p-2" style={{ backgroundColor: 'rgba(0, 255, 0, 0.1)', borderRadius: '5px' }}>
                                <p className="text-sm"><strong>Format:</strong> {data.metadata.format}</p>
                                <p className="text-sm"><strong>Files:</strong> {data.metadata.fileCount}</p>
                                <p className="text-sm"><strong>Size:</strong> {data.metadata.totalSize} bytes</p>
                            </div>
                        )}
                        
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr>
                                    <th style={{ textAlign: 'left', padding: '8px', borderBottom: '1px solid #00ff00' }}>Filename</th>
                                    <th style={{ textAlign: 'right', padding: '8px', borderBottom: '1px solid #00ff00' }}>Size</th>
                                    <th style={{ textAlign: 'center', padding: '8px', borderBottom: '1px solid #00ff00' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data && data.files && data.files.map((entry, index) => (
                                    <tr 
                                        key={index}
                                        style={{ 
                                            borderBottom: '1px solid rgba(0, 255, 0, 0.2)',
                                            backgroundColor: selectedEntry === index ? 'rgba(0, 255, 0, 0.1)' : 'transparent'
                                        }}
                                        onClick={() => setSelectedEntry(index)}
                                    >
                                        <td style={{ padding: '8px' }}>
                                            {getFileType(entry.name).icon} {entry.name}
                                        </td>
                                        <td style={{ padding: '8px', textAlign: 'right' }}>
                                            {entry.size} bytes
                                        </td>
                                        <td style={{ padding: '8px', textAlign: 'center' }}>
                                            <button 
                                                className="matrix-button text-xs m-1"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    previewFile(entry, index);
                                                }}
                                            >
                                                Preview
                                            </button>
                                            <button 
                                                className="matrix-button text-xs m-1"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleExtractFile(entry, index);
                                                }}
                                            >
                                                Extract
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {/* Extraction Dialog */}
                    {showExtractionDialog && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 1000
                            }}
                        >
                            <div 
                                style={{
                                    backgroundColor: '#001a00',
                                    border: '1px solid #00ff00',
                                    padding: '20px',
                                    borderRadius: '5px',
                                    width: '400px'
                                }}
                            >
                                <h3 className="matrix-title text-sm mb-4">
                                    {extractingFile 
                                        ? `Extract ${extractingFile.name}` 
                                        : `Extract All Files (${data?.files?.length || 0} files)`}
                                </h3>
                                
                                <div className="mb-4">
                                    <label className="text-sm block mb-2">Extraction Path:</label>
                                    <input 
                                        type="text" 
                                        value={extractionPath}
                                        onChange={(e) => setExtractionPath(e.target.value)}
                                        style={{
                                            backgroundColor: '#000800',
                                            color: '#00ff00',
                                            border: '1px solid #00ff00',
                                            padding: '8px',
                                            width: '100%'
                                        }}
                                    />
                                </div>
                                
                                {extractionProgress > 0 && (
                                    <div className="mb-4">
                                        <div style={{ 
                                            height: '20px', 
                                            backgroundColor: '#000800',
                                            border: '1px solid #00ff00',
                                            borderRadius: '3px',
                                            overflow: 'hidden'
                                        }}>
                                            <div style={{
                                                height: '100%',
                                                width: `${extractionProgress}%`,
                                                backgroundColor: '#00ff00',
                                                transition: 'width 0.3s'
                                            }}></div>
                                        </div>
                                        <p className="text-sm mt-2 text-center">{extractionProgress}%</p>
                                    </div>
                                )}
                                
                                <div className="flex justify-between">
                                    <button 
                                        className="matrix-button text-xs"
                                        onClick={() => setShowExtractionDialog(false)}
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        className="matrix-button text-xs"
                                        onClick={processExtraction}
                                    >
                                        Extract
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Component: Assembly Viewer (for DLL/EXE files)
        const AssemblyViewer = ({ file, data }) => {
            const [activeTab, setActiveTab] = useState('info');
            const [isDecompiling, setIsDecompiling] = useState(false);
            const [decompilerOutput, setDecompilerOutput] = useState(null);
            const monacoRef = useRef(null);
            
            if (!data) {
                return (
                    <div className="editor-container p-4 flex items-center justify-center">
                        <p>Loading assembly information...</p>
                    </div>
                );
            }
            
            // Handle decompile action
            const handleDecompile = () => {
                setIsDecompiling(true);
                
                // Simulate decompilation process (would use a real decompiler in production)
                setTimeout(() => {
                    // Generate pseudo-code based on the sections and imports data
                    let pseudoCode = '';
                    
                    // Add header
                    pseudoCode += `// Decompiled from ${file.name}\n`;
                    pseudoCode += `// ${data.isDll ? 'Dynamic Link Library' : 'Executable'}\n`;
                    pseudoCode += `// Architecture: ${data.machine === 0x014c ? 'x86' : data.machine === 0x8664 ? 'x64' : 'Unknown'}\n`;
                    pseudoCode += `// Timestamp: ${data.timestamp}\n\n`;
                    
                    // Add imports
                    pseudoCode += '// Imported libraries and functions\n';
                    data.imports.forEach(lib => {
                        pseudoCode += `#include <${lib.dll.replace('.dll', '')}>\n`;
                    });
                    pseudoCode += '\n';
                    
                    // Add exports
                    if (data.exports.length > 0) {
                        pseudoCode += '// Exported functions\n';
                        data.exports.forEach(exp => {
                            // Generate sample function code
                            pseudoCode += `\n/* Function: ${exp.name} (Ordinal: ${exp.ordinal}) */\n`;
                            pseudoCode += `DWORD WINAPI ${exp.name}(LPVOID lpParam) {\n`;
                            
                            // Add sample implementation
                            if (exp.name.toLowerCase().includes('init') || exp.name.toLowerCase().includes('initialize')) {
                                pseudoCode += '    // Initialize component\n';
                                pseudoCode += '    if (!InitializeInternalStructures()) {\n';
                                pseudoCode += '        return ERROR_INITIALIZATION_FAILED;\n';
                                pseudoCode += '    }\n';
                                pseudoCode += '    \n';
                                pseudoCode += '    // Register with system\n';
                                pseudoCode += '    HANDLE hSystem = RegisterSystemCallback(OnSystemEvent);\n';
                                pseudoCode += '    if (hSystem == INVALID_HANDLE_VALUE) {\n';
                                pseudoCode += '        return GetLastError();\n';
                                pseudoCode += '    }\n';
                                pseudoCode += '    \n';
                                pseudoCode += '    g_IsInitialized = TRUE;\n';
                                pseudoCode += '    return ERROR_SUCCESS;\n';
                            } else if (exp.name.toLowerCase().includes('shutdown') || exp.name.toLowerCase().includes('close')) {
                                pseudoCode += '    // Clean up resources\n';
                                pseudoCode += '    if (g_IsInitialized) {\n';
                                pseudoCode += '        UnregisterSystemCallback(g_hSystem);\n';
                                pseudoCode += '        FreeInternalStructures();\n';
                                pseudoCode += '        g_IsInitialized = FALSE;\n';
                                pseudoCode += '    }\n';
                                pseudoCode += '    \n';
                                pseudoCode += '    return ERROR_SUCCESS;\n';
                            } else if (exp.name.toLowerCase().includes('process')) {
                                pseudoCode += '    // Process incoming data\n';
                                pseudoCode += '    PDATA_STRUCTURE pData = (PDATA_STRUCTURE)lpParam;\n';
                                pseudoCode += '    if (!pData || pData->dwSize < sizeof(DATA_STRUCTURE)) {\n';
                                pseudoCode += '        return ERROR_INVALID_PARAMETER;\n';
                                pseudoCode += '    }\n';
                                pseudoCode += '    \n';
                                pseudoCode += '    // Process data\n';
                                pseudoCode += '    switch(pData->dwType) {\n';
                                pseudoCode += '        case DATA_TYPE_COMMAND:\n';
                                pseudoCode += '            return ProcessCommand(&pData->Command);\n';
                                pseudoCode += '        case DATA_TYPE_QUERY:\n';
                                pseudoCode += '            return ProcessQuery(&pData->Query);\n';
                                pseudoCode += '        default:\n';
                                pseudoCode += '            return ERROR_INVALID_PARAMETER;\n';
                                pseudoCode += '    }\n';
                            } else {
                                pseudoCode += '    // Implementation not available\n';
                                pseudoCode += '    return ERROR_SUCCESS;\n';
                            }
                            
                            pseudoCode += '}\n';
                        });
                    }
                    
                    // If no exports, add a main function for executables
                    if (data.exports.length === 0 && !data.isDll) {
                        pseudoCode += '\n/* Main entry point */\n';
                        pseudoCode += 'int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {\n';
                        pseudoCode += '    // Initialize application\n';
                        pseudoCode += '    if (!InitializeApplication(hInstance)) {\n';
                        pseudoCode += '        MessageBox(NULL, "Failed to initialize application", "Error", MB_OK | MB_ICONERROR);\n';
                        pseudoCode += '        return 1;\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Create main window\n';
                        pseudoCode += '    HWND hWnd = CreateMainWindow(hInstance);\n';
                        pseudoCode += '    if (!hWnd) {\n';
                        pseudoCode += '        MessageBox(NULL, "Failed to create main window", "Error", MB_OK | MB_ICONERROR);\n';
                        pseudoCode += '        return 1;\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Show window\n';
                        pseudoCode += '    ShowWindow(hWnd, nCmdShow);\n';
                        pseudoCode += '    UpdateWindow(hWnd);\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Message loop\n';
                        pseudoCode += '    MSG msg;\n';
                        pseudoCode += '    while (GetMessage(&msg, NULL, 0, 0)) {\n';
                        pseudoCode += '        TranslateMessage(&msg);\n';
                        pseudoCode += '        DispatchMessage(&msg);\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    return (int)msg.wParam;\n';
                        pseudoCode += '}\n';
                    }
                    
                    // Add a section for Matrix Online specific code
                    if (file.name.toLowerCase().includes('matrix') || 
                        file.name.toLowerCase().includes('mxo') || 
                        file.name.toLowerCase().includes('lithtech')) {
                        
                        pseudoCode += '\n/* Matrix Online specific functions */\n';
                        pseudoCode += '\n// Lithtech engine interface\n';
                        pseudoCode += 'BOOL InitializeLithtech(HMODULE hModule) {\n';
                        pseudoCode += '    // Initialize Lithtech engine\n';
                        pseudoCode += '    g_pLTClient = (ILTClient*)GetProcAddress(hModule, "LTClientCreate");\n';
                        pseudoCode += '    if (!g_pLTClient) {\n';
                        pseudoCode += '        return FALSE;\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Initialize render system\n';
                        pseudoCode += '    RENDER_INIT_PARAMS params;\n';
                        pseudoCode += '    memset(&params, 0, sizeof(params));\n';
                        pseudoCode += '    params.m_Width = 800;\n';
                        pseudoCode += '    params.m_Height = 600;\n';
                        pseudoCode += '    params.m_BPP = 32;\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    if (g_pLTClient->InitRender(&params) != LT_OK) {\n';
                        pseudoCode += '        return FALSE;\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    return TRUE;\n';
                        pseudoCode += '}\n';
                        
                        pseudoCode += '\n// Matrix Online character creation\n';
                        pseudoCode += 'HCHARACTER CreateMatrixCharacter(const char* pszModelFile) {\n';
                        pseudoCode += '    CLIENT_OBJECT_CREATE_STRUCT createStruct;\n';
                        pseudoCode += '    memset(&createStruct, 0, sizeof(createStruct));\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Set up character properties\n';
                        pseudoCode += '    strcpy(createStruct.m_Filename, pszModelFile);\n';
                        pseudoCode += '    createStruct.m_ObjectType = OT_MODEL;\n';
                        pseudoCode += '    createStruct.m_Flags = FLAG_VISIBLE;\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    // Create the character\n';
                        pseudoCode += '    HOBJECT hObject;\n';
                        pseudoCode += '    if (g_pLTClient->CreateObject(&createStruct, &hObject) != LT_OK) {\n';
                        pseudoCode += '        return NULL;\n';
                        pseudoCode += '    }\n';
                        pseudoCode += '    \n';
                        pseudoCode += '    return (HCHARACTER)hObject;\n';
                        pseudoCode += '}\n';
                    }
                    
                    // Set the decompiled output
                    setDecompilerOutput(pseudoCode);
                    
                    // Switch to decompile tab
                    setActiveTab('decompile');
                    setIsDecompiling(false);
                }, 2000);
            };
            
            // Initialize Monaco editor for decompiled code
            const initMonacoEditor = (container) => {
                if (!container || !decompilerOutput) return;
                
                monacoRef.current = container;
                
                require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' }});
                require(['vs/editor/editor.main'], () => {
                    if (container.innerHTML !== '') {
                        // Editor already initialized
                        return;
                    }
                    
                    // Create editor
                    const editor = monaco.editor.create(container, {
                        value: decompilerOutput,
                        language: 'cpp',
                        theme: 'vs-dark',
                        minimap: { enabled: true },
                        readOnly: false,
                        automaticLayout: true,
                        scrollBeyondLastLine: false,
                        fontSize: 14
                    });
                });
            };
            
            return (
                <div className="editor-container">
                    <div className="p-2 flex justify-between items-center">
                        <h3 className="matrix-title text-sm">Assembly Viewer: {file.name}</h3>
                        <div>
                            <button className="matrix-button m-2 text-xs">Export</button>
                            <button 
                                className="matrix-button m-2 text-xs" 
                                onClick={handleDecompile}
                                disabled={isDecompiling}
                            >
                                {isDecompiling ? 'Decompiling...' : 'Decompile'}
                            </button>
                        </div>
                    </div>
                    
                    <div className="border-b border-green-900">
                        <div className="flex">
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'info' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('info')}
                            >
                                Information
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'sections' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('sections')}
                            >
                                Sections
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'imports' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('imports')}
                            >
                                Imports
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'exports' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => setActiveTab('exports')}
                            >
                                Exports
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeTab === 'decompile' ? 'bg-green-900 text-green-100' : ''}`}
                                onClick={() => {
                                    if (decompilerOutput) {
                                        setActiveTab('decompile');
                                    } else {
                                        handleDecompile();
                                    }
                                }}
                            >
                                Decompiled Code
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-4 overflow-auto" style={{ height: 'calc(100% - 80px)' }}>
                        {activeTab === 'info' && (
                            <div>
                                <h4 className="text-sm font-bold mb-2">Assembly Information</h4>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <tbody>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Type</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.isDll ? 'Dynamic Link Library (DLL)' : 'Executable (EXE)'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Machine</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.machine === 0x014c ? 'x86 (32-bit)' : 
                                                 data.machine === 0x8664 ? 'x64 (64-bit)' : 
                                                 `Unknown (0x${data.machine.toString(16)})`}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Timestamp</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.timestamp}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Managed Code</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.metadata.isManagedCode ? 'Yes (.NET)' : 'No (Native)'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Sections</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.sections.length}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Imports</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.imports.reduce((sum, lib) => sum + lib.functions.length, 0)} functions from {data.imports.length} libraries
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>Exports</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {data.exports.length} functions
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>File Size</td>
                                            <td style={{ padding: '8px', borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                {file.size} bytes
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div className="mt-4 p-2" style={{ backgroundColor: 'rgba(0, 255, 0, 0.1)', borderRadius: '5px' }}>
                                    <h4 className="text-sm font-bold mb-2">References</h4>
                                    <p className="text-sm">This assembly references the following libraries:</p>
                                    <ul className="text-sm mt-2">
                                        {data.imports.map((lib, index) => (
                                            <li key={index} className="ml-4">{lib.dll}</li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'sections' && (
                            <div>
                                <h4 className="text-sm font-bold mb-2">PE Sections</h4>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr>
                                            <th style={{ textAlign: 'left', padding: '8px', borderBottom: '1px solid #00ff00' }}>Name</th>
                                            <th style={{ textAlign: 'right', padding: '8px', borderBottom: '1px solid #00ff00' }}>Virtual Size</th>
                                            <th style={{ textAlign: 'right', padding: '8px', borderBottom: '1px solid #00ff00' }}>Virtual Address</th>
                                            <th style={{ textAlign: 'right', padding: '8px', borderBottom: '1px solid #00ff00' }}>Raw Size</th>
                                            <th style={{ textAlign: 'right', padding: '8px', borderBottom: '1px solid #00ff00' }}>Raw Offset</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.sections.map((section, index) => (
                                            <tr key={index} style={{ borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                <td style={{ padding: '8px' }}>{section.name}</td>
                                                <td style={{ padding: '8px', textAlign: 'right' }}>{section.virtualSize} bytes</td>
                                                <td style={{ padding: '8px', textAlign: 'right' }}>0x{section.virtualAddress.toString(16).toUpperCase()}</td>
                                                <td style={{ padding: '8px', textAlign: 'right' }}>{section.rawDataSize} bytes</td>
                                                <td style={{ padding: '8px', textAlign: 'right' }}>0x{section.rawDataOffset.toString(16).toUpperCase()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {activeTab === 'imports' && (
                            <div>
                                <h4 className="text-sm font-bold mb-2">Imported Functions</h4>
                                {data.imports.map((lib, libIndex) => (
                                    <div key={libIndex} className="mb-4">
                                        <h5 className="text-sm font-bold p-2" style={{ backgroundColor: 'rgba(0, 255, 0, 0.1)' }}>
                                            {lib.dll}
                                        </h5>
                                        <ul style={{ listStyle: 'none', padding: 0 }}>
                                            {lib.functions.map((func, funcIndex) => (
                                                <li key={funcIndex} style={{ padding: '4px 8px', borderBottom: '1px solid rgba(0, 255, 0, 0.1)' }}>
                                                    {func}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {activeTab === 'exports' && (
                            <div>
                                <h4 className="text-sm font-bold mb-2">Exported Functions</h4>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr>
                                            <th style={{ textAlign: 'left', padding: '8px', borderBottom: '1px solid #00ff00' }}>Ordinal</th>
                                            <th style={{ textAlign: 'left', padding: '8px', borderBottom: '1px solid #00ff00' }}>Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.exports.map((exp, index) => (
                                            <tr key={index} style={{ borderBottom: '1px solid rgba(0, 255, 0, 0.2)' }}>
                                                <td style={{ padding: '8px' }}>{exp.ordinal}</td>
                                                <td style={{ padding: '8px' }}>{exp.name}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {activeTab === 'decompile' && (
                            <div>
                                {isDecompiling ? (
                                    <div className="flex flex-col items-center justify-center h-full">
                                        <div className="text-center">
                                            <div className="inline-block w-8 h-8 border-t-2 border-r-2 border-green-500 rounded-full animate-spin"></div>
                                            <p className="mt-4">Decompiling assembly code...</p>
                                            <p className="text-xs mt-2">This may take a few moments</p>
                                        </div>
                                    </div>
                                ) : decompilerOutput ? (
                                    <div style={{ height: '500px', minHeight: '500px' }} ref={initMonacoEditor}></div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full">
                                        <p>Click the "Decompile" button to generate decompiled code.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // Component: File Preview
        const FilePreview = ({ file, data }) => {
            if (!file) {
                return (
                    <div className="preview-container p-4">
                        <h3 className="matrix-title text-sm">Preview</h3>
                        <div className="p-4 text-sm text-center">
                            Select a file to preview
                        </div>
                    </div>
                );
            }
            
            const fileType = getFileType(file.name);
            
            return (
                <div className="preview-container">
                    <div className="p-2">
                        <h3 className="matrix-title text-sm">Preview: {file.name}</h3>
                    </div>
                    <div className="p-4">
                        <div className="p-2 border rounded" style={{ borderColor: 'rgba(0, 255, 0, 0.3)' }}>
                            <h4 style={{ borderBottom: '1px solid rgba(0, 255, 0, 0.3)', paddingBottom: '8px' }}>
                                {fileType.name} File
                            </h4>
                            <p className="text-sm">{fileType.description}</p>
                            
                            {data && data.metadata && (
                                <div className="mt-4">
                                    <h4 style={{ borderBottom: '1px solid rgba(0, 255, 0, 0.3)', paddingBottom: '8px' }}>
                                        Metadata
                                    </h4>
                                    <ul style={{ listStyle: 'none', padding: 0 }}>
                                        {Object.entries(data.metadata).map(([key, value]) => (
                                            <li key={key} className="text-sm" style={{ padding: '4px 0' }}>
                                                <strong>{key}:</strong> {JSON.stringify(value)}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                            
                            <div className="mt-4">
                                <h4 style={{ borderBottom: '1px solid rgba(0, 255, 0, 0.3)', paddingBottom: '8px' }}>
                                    File Information
                                </h4>
                                <ul style={{ listStyle: 'none', padding: 0 }}>
                                    <li className="text-sm" style={{ padding: '4px 0' }}>
                                        <strong>Size:</strong> {file.size} bytes
                                    </li>
                                    <li className="text-sm" style={{ padding: '4px 0' }}>
                                        <strong>Last Modified:</strong> {new Date(file.lastModified).toLocaleString()}
                                    </li>
                                    <li className="text-sm" style={{ padding: '4px 0' }}>
                                        <strong>Type:</strong> {file.type || 'application/octet-stream'}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Main App Component
        const App = () => {
            const [files, setFiles] = useState({});
            const [allFiles, setAllFiles] = useState({});
            const [selectedFilePath, setSelectedFilePath] = useState(null);
            const [selectedFile, setSelectedFile] = useState(null);
            const [fileData, setFileData] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [activeView, setActiveView] = useState('explorer');
            
            // Handle directory selection
            const handleDirectorySelect = (e) => {
                const dirInput = e.target;
                
                if (dirInput.files.length === 0) return;
                
                setIsLoading(true);
                
                // Process files and organize into a tree structure
                const fileTree = {};
                const flatFiles = {};
                const filePromises = [];
                
                for (let i = 0; i < dirInput.files.length; i++) {
                    const file = dirInput.files[i];
                    const path = file.webkitRelativePath;
                    const pathParts = path.split('/');
                    
                    // Skip hidden files
                    if (pathParts.some(part => part.startsWith('.'))) continue;
                    
                    // Add to flat structure for type-based views
                    flatFiles[path] = {
                        type: 'file',
                        file: file
                    };
                    
                    // Build tree structure
                    let currentLevel = fileTree;
                    for (let j = 0; j < pathParts.length - 1; j++) {
                        const part = pathParts[j];
                        if (!currentLevel[part]) {
                            currentLevel[part] = {
                                type: 'folder',
                                children: {}
                            };
                        }
                        currentLevel = currentLevel[part].children;
                    }
                    
                    // Add file
                    const fileName = pathParts[pathParts.length - 1];
                    currentLevel[fileName] = {
                        type: 'file',
                        file: file
                    };
                    
                    filePromises.push(Promise.resolve());
                }
                
                // Wait for all files to be processed
                Promise.all(filePromises)
                    .then(() => {
                        setFiles(fileTree);
                        setAllFiles(flatFiles);
                        setIsLoading(false);
                    })
                    .catch(error => {
                        console.error('Error processing files:', error);
                        setIsLoading(false);
                        alert('Error processing files. See console for details.');
                    });
            };
            
            // Handle file selection from tree
            const handleFileSelect = async (path, fileInfo) => {
                if (fileInfo.type !== 'file' || !fileInfo.file) return;
                
                setSelectedFilePath(path);
                setSelectedFile(fileInfo.file);
                setFileData(null);
                setIsLoading(true);
                
                try {
                    // Parse file based on type
                    const fileName = path.split('/').pop();
                    const fileExt = '.' + fileName.split('.').pop().toLowerCase();
                    
                    let parsedData = null;
                    
                    if (FILE_TYPES.MODEL.extensions.includes(fileExt)) {
                        try {
                            // For 3D models, parse and prepare for display
                            console.log(`Processing 3D model: ${fileName}`);
                            parsedData = await LithtechParsers.parseABC(fileInfo.file);
                            
                            // If this is coming from the models tab, automatically focus the 3D view
                            if (activeView === 'models') {
                                parsedData.initialTab = 'view';
                            }
                        } catch (error) {
                            console.error('Error parsing 3D model:', error);
                            // Provide a placeholder model if parsing fails
                            parsedData = {
                                type: 'model',
                                vertices: [],
                                indices: [],
                                uvs: [],
                                normals: [],
                                animations: [],
                                materials: [],
                                metadata: {
                                    format: fileExt === '.abc' ? 'ABC' : 'MOB',
                                    version: 1.0,
                                    error: 'Could not parse model file'
                                }
                            };
                        }
                    } else if (FILE_TYPES.TEXTURE.extensions.includes(fileExt)) {
                        try {
                            // For texture files
                            console.log(`Processing texture: ${fileName}`);
                            parsedData = await LithtechParsers.parseDTX(fileInfo.file);
                        } catch (error) {
                            console.error('Error parsing texture:', error);
                            // Create a placeholder texture
                            const canvas = document.createElement('canvas');
                            canvas.width = 256;
                            canvas.height = 256;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#001a00';
                            ctx.fillRect(0, 0, 256, 256);
                            ctx.strokeStyle = '#00ff00';
                            ctx.strokeRect(0, 0, 256, 256);
                            ctx.font = '14px monospace';
                            ctx.fillStyle = '#00ff00';
                            ctx.fillText(`Error: Could not parse ${fileName}`, 10, 128);
                            
                            parsedData = {
                                type: 'texture',
                                canvas: canvas,
                                width: 256,
                                height: 256,
                                format: 'DTX',
                                metadata: {
                                    material: 'default',
                                    error: 'Could not parse texture file'
                                }
                            };
                        }
                    } else if (FILE_TYPES.LEVEL.extensions.includes(fileExt)) {
                        parsedData = await LithtechParsers.parseDAT(fileInfo.file);
                    } else if (FILE_TYPES.ARCHIVE.extensions.includes(fileExt)) {
                        console.log(`Processing archive: ${fileName}`);
                        parsedData = await LithtechParsers.parseArchive(fileInfo.file);
                    } else if (FILE_TYPES.MESSAGE.extensions.includes(fileExt)) {
                        parsedData = await LithtechParsers.parseMessage(fileInfo.file);
                    } else if (FILE_TYPES.ASSEMBLY.extensions.includes(fileExt)) {
                        // For DLL and EXE files
                        try {
                            console.log(`Processing assembly: ${fileName}`);
                            parsedData = await LithtechParsers.parseAssembly(fileInfo.file);
                        } catch (error) {
                            console.warn('Error parsing assembly file:', error);
                            alert('Error parsing assembly file. It may not be a valid PE file.');
                            parsedData = { 
                                type: 'binary',
                                metadata: {
                                    format: 'DLL/EXE',
                                    error: 'Could not parse assembly file'
                                }
                            };
                        }
                    } else if (FILE_TYPES.CUTSCENE.extensions.includes(fileExt)) {
                        // For video files, prepare for playback
                        console.log(`Processing video: ${fileName}`);
                        const url = URL.createObjectURL(fileInfo.file);
                        parsedData = { 
                            type: 'cutscene', 
                            url,
                            metadata: {
                                format: fileExt.substring(1).toUpperCase(),
                                filename: fileName
                            }
                        };
                    } else if (FILE_TYPES.SCRIPT.extensions.includes(fileExt)) {
                        // For scripts, just read as text
                        console.log(`Processing script: ${fileName}`);
                        const text = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = e => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsText(fileInfo.file);
                        });
                        parsedData = { 
                            type: 'script', 
                            content: text,
                            metadata: {
                                format: fileExt.substring(1).toUpperCase(),
                                filename: fileName
                            }
                        };
                    } else if (FILE_TYPES.SOUND.extensions.includes(fileExt)) {
                        // For audio, create a URL for playback
                        console.log(`Processing audio: ${fileName}`);
                        const url = URL.createObjectURL(fileInfo.file);
                        parsedData = { 
                            type: 'audio', 
                            url,
                            metadata: {
                                format: fileExt.substring(1).toUpperCase(),
                                filename: fileName
                            }
                        };
                    } else {
                        // Default: try to read as text
                        try {
                            const text = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = e => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsText(fileInfo.file);
                            });
                            parsedData = { type: 'text', content: text };
                        } catch (error) {
                            console.warn('Could not read file as text:', error);
                            parsedData = { type: 'binary' };
                        }
                    }
                    
                    setFileData(parsedData);
                } catch (error) {
                    console.error('Error parsing file:', error);
                    alert('Error parsing file. See console for details.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            // Handle extracted files
            const handleExtractedFiles = (extractedFiles) => {
                if (!extractedFiles || extractedFiles.length === 0) return;
                
                // Create a new file tree structure for the extracted files
                const newFiles = { ...files };
                
                // Create "extracted" folder if it doesn't exist
                if (!newFiles['extracted']) {
                    newFiles['extracted'] = {
                        type: 'folder',
                        children: {}
                    };
                }
                
                // Add extracted files to the tree
                extractedFiles.forEach(extractedFile => {
                    const pathParts = extractedFile.path.split('/');
                    let currentLevel = newFiles;
                    
                    // Navigate to the right folder level
                    for (let i = 0; i < pathParts.length - 1; i++) {
                        const part = pathParts[i];
                        if (part === '') continue; // Skip empty parts
                        
                        if (!currentLevel[part]) {
                            currentLevel[part] = {
                                type: 'folder',
                                children: {}
                            };
                        }
                        
                        if (currentLevel[part].type === 'folder') {
                            currentLevel = currentLevel[part].children;
                        } else {
                            // Handle the case where a folder name conflicts with a file name
                            const newFolderName = part + '_folder';
                            currentLevel[newFolderName] = {
                                type: 'folder',
                                children: {}
                            };
                            currentLevel = currentLevel[newFolderName].children;
                        }
                    }
                    
                    // Add the file
                    const fileName = pathParts[pathParts.length - 1];
                    currentLevel[fileName] = {
                        type: 'file',
                        file: extractedFile.file
                    };
                });
                
                // Update the file tree
                setFiles(newFiles);
            };
            
            // Render appropriate editor based on file type
            const renderEditor = () => {
                if (!selectedFile || !fileData) {
                    return (
                        <div className="editor-container p-4 flex items-center justify-center">
                            <div className="text-center">
                                <h3 className="matrix-title text-sm">No File Selected</h3>
                                <p className="text-sm mt-4">
                                    Select a file from the tree to edit
                                </p>
                            </div>
                        </div>
                    );
                }
                
                const fileExt = '.' + selectedFile.name.split('.').pop().toLowerCase();
                
                if (FILE_TYPES.MODEL.extensions.includes(fileExt)) {
                    return <ModelEditor file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.TEXTURE.extensions.includes(fileExt)) {
                    return <TextureEditor file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.LEVEL.extensions.includes(fileExt)) {
                    return <LevelEditor file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.ARCHIVE.extensions.includes(fileExt)) {
                    return <ArchiveViewer 
                        file={selectedFile} 
                        data={fileData} 
                        onFileExtracted={handleExtractedFiles} 
                    />;
                } else if (FILE_TYPES.ASSEMBLY.extensions.includes(fileExt)) {
                    return <AssemblyViewer file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.SOUND.extensions.includes(fileExt)) {
                    return <AudioEditor file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.CUTSCENE.extensions.includes(fileExt)) {
                    return <CutscenePlayer file={selectedFile} data={fileData} />;
                } else if (FILE_TYPES.ANIMATION.extensions.includes(fileExt)) {
                    // For animation files, use model editor but set to animation tab
                    return <ModelEditor file={selectedFile} data={{...fileData, initialTab: 'animation'}} />;
                } else {
                    // Default to text editor for scripts, messages, and other text files
                    return (
                        <TextEditor 
                            file={selectedFile} 
                            data={fileData} 
                            onSave={(content) => console.log('Save:', content)}
                        />
                    );
                }
            };
            
            return (
                <div>
                    {/* Header */}
                    <div className="matrix-header">
                        <div className="matrix-title">Matrix Online Modding Suite</div>
                        <div className="flex">
                            <input 
                                type="file" 
                                webkitdirectory="true" 
                                directory="true"
                                style={{ display: 'none' }}
                                id="directory-input"
                                onChange={handleDirectorySelect}
                            />
                            <label htmlFor="directory-input" className="matrix-button">
                                Load Directory
                            </label>
                        </div>
                    </div>
                    
                    {/* Main Navigation */}
                    <div className="border-b border-green-900 bg-black">
                        <div className="flex">
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'explorer' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('explorer')}
                            >
                                File Explorer
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'models' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('models')}
                            >
                                3D Models
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'textures' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('textures')}
                            >
                                Textures
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'audio' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('audio')}
                            >
                                Audio
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'cutscenes' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('cutscenes')}
                            >
                                Cutscenes
                            </div>
                            <div 
                                className={`px-4 py-2 cursor-pointer ${activeView === 'archives' ? 'bg-green-900 text-green-100' : 'text-green-500'}`}
                                onClick={() => setActiveView('archives')}
                            >
                                Archives
                            </div>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    {activeView === 'explorer' ? (
                        <div className="flex" style={{ height: 'calc(100vh - 100px)' }}>
                            {/* File Tree */}
                            <div style={{ width: '20%' }}>
                                <FileTree 
                                    files={files}
                                    onFileSelect={handleFileSelect}
                                    selectedFile={selectedFilePath}
                                />
                            </div>
                            
                            {/* Editor Area */}
                            <div style={{ width: '60%' }}>
                                {renderEditor()}
                            </div>
                            
                            {/* Preview/Properties */}
                            <div style={{ width: '20%' }}>
                                <FilePreview file={selectedFile} data={fileData} />
                            </div>
                        </div>
                    ) : activeView === 'models' ? (
                        <div className="p-4" style={{ height: 'calc(100vh - 100px)', overflowY: 'auto' }}>
                            <h3 className="matrix-title mb-4">3D Models Browser</h3>
                            <div className="grid grid-cols-3 gap-4">
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.MODEL.extensions.includes(ext);
                                }).map(([path, fileInfo], index) => (
                                    <div 
                                        key={index} 
                                        className="border border-green-500 p-2 cursor-pointer hover:bg-green-900 hover:bg-opacity-20"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleFileSelect(path, fileInfo);
                                            setActiveView('explorer'); // Switch to explorer view to show the editor
                                        }}
                                    >
                                        <div className="bg-black bg-opacity-50 aspect-square flex items-center justify-center">
                                            <span className="text-4xl">📊</span>
                                        </div>
                                        <div className="p-2 text-center truncate" title={path.split('/').pop()}>
                                            {path.split('/').pop()}
                                        </div>
                                    </div>
                                ))}
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.MODEL.extensions.includes(ext);
                                }).length === 0 && (
                                    <div className="col-span-3 text-center p-8">
                                        <p>No 3D model files found. Load a directory containing .abc or .mob files.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : activeView === 'textures' ? (
                        <div className="p-4" style={{ height: 'calc(100vh - 100px)', overflowY: 'auto' }}>
                            <h3 className="matrix-title mb-4">Textures Browser</h3>
                            <div className="grid grid-cols-4 gap-4">
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.TEXTURE.extensions.includes(ext);
                                }).map(([path, fileInfo], index) => (
                                    <div 
                                        key={index} 
                                        className="border border-green-500 p-2 cursor-pointer hover:bg-green-900 hover:bg-opacity-20"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleFileSelect(path, fileInfo);
                                            setActiveView('explorer'); // Switch to explorer view to show the editor
                                        }}
                                    >
                                        <div className="bg-black bg-opacity-50 aspect-square flex items-center justify-center">
                                            <span className="text-4xl">🖼️</span>
                                        </div>
                                        <div className="p-2 text-center truncate" title={path.split('/').pop()}>
                                            {path.split('/').pop()}
                                        </div>
                                    </div>
                                ))}
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.TEXTURE.extensions.includes(ext);
                                }).length === 0 && (
                                    <div className="col-span-4 text-center p-8">
                                        <p>No texture files found. Load a directory containing .dtx or other image files.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : activeView === 'audio' ? (
                        <div className="p-4" style={{ height: 'calc(100vh - 100px)', overflowY: 'auto' }}>
                            <h3 className="matrix-title mb-4">Audio Browser</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.SOUND.extensions.includes(ext);
                                }).map(([path, fileInfo], index) => (
                                    <div 
                                        key={index} 
                                        className="border border-green-500 p-2 cursor-pointer hover:bg-green-900 hover:bg-opacity-20 flex items-center"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleFileSelect(path, fileInfo);
                                            setActiveView('explorer'); // Switch to explorer view to show the editor
                                        }}
                                    >
                                        <span className="text-2xl mr-4">🔊</span>
                                        <div className="flex-grow">
                                            <div className="font-bold">{path.split('/').pop()}</div>
                                            <div className="text-xs opacity-70">{path}</div>
                                        </div>
                                        <div className="text-xs">
                                            {Math.floor(fileInfo.file.size / 1024)} KB
                                        </div>
                                    </div>
                                ))}
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.SOUND.extensions.includes(ext);
                                }).length === 0 && (
                                    <div className="text-center p-8">
                                        <p>No audio files found. Load a directory containing .wav, .ogg, or .mp3 files.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : activeView === 'cutscenes' ? (
                        <div className="p-4" style={{ height: 'calc(100vh - 100px)', overflowY: 'auto' }}>
                            <h3 className="matrix-title mb-4">Cutscenes Browser</h3>
                            <div className="grid grid-cols-2 gap-4">
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.CUTSCENE.extensions.includes(ext);
                                }).map(([path, fileInfo], index) => (
                                    <div 
                                        key={index} 
                                        className="border border-green-500 p-2 cursor-pointer hover:bg-green-900 hover:bg-opacity-20"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleFileSelect(path, fileInfo);
                                            setActiveView('explorer'); // Switch to explorer view to show the editor
                                        }}
                                    >
                                        <div className="bg-black bg-opacity-50 aspect-video flex items-center justify-center">
                                            <span className="text-4xl">🎬</span>
                                        </div>
                                        <div className="p-2">
                                            <div className="font-bold truncate" title={path.split('/').pop()}>
                                                {path.split('/').pop()}
                                            </div>
                                            <div className="flex justify-between text-xs mt-1">
                                                <span>Format: {path.split('.').pop().toUpperCase()}</span>
                                                <span>{Math.floor(fileInfo.file.size / 1024)} KB</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.CUTSCENE.extensions.includes(ext);
                                }).length === 0 && (
                                    <div className="col-span-2 text-center p-8">
                                        <p>No cutscene files found. Load a directory containing .bik, .smk, or other video files.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : activeView === 'archives' ? (
                        <div className="p-4" style={{ height: 'calc(100vh - 100px)', overflowY: 'auto' }}>
                            <h3 className="matrix-title mb-4">Archives Browser</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.ARCHIVE.extensions.includes(ext);
                                }).map(([path, fileInfo], index) => (
                                    <div 
                                        key={index} 
                                        className="border border-green-500 p-2 cursor-pointer hover:bg-green-900 hover:bg-opacity-20 flex items-center"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleFileSelect(path, fileInfo);
                                            setActiveView('explorer'); // Switch to explorer view to show the editor
                                        }}
                                    >
                                        <span className="text-2xl mr-4">📦</span>
                                        <div className="flex-grow">
                                            <div className="font-bold">{path.split('/').pop()}</div>
                                            <div className="text-xs opacity-70">{path}</div>
                                        </div>
                                        <div className="text-xs">
                                            {Math.floor(fileInfo.file.size / 1024)} KB
                                        </div>
                                    </div>
                                ))}
                                {Object.entries(allFiles).filter(([path, fileInfo]) => {
                                    const ext = '.' + path.split('.').pop().toLowerCase();
                                    return FILE_TYPES.ARCHIVE.extensions.includes(ext);
                                }).length === 0 && (
                                    <div className="text-center p-8">
                                        <p>No archive files found. Load a directory containing .rez, .lta, .ltb, or .pkb files.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : null}
                    
                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="loading-matrix">
                            <canvas id="matrix-rain-overlay" className="matrix-rain"></canvas>
                            <div className="loading-text">Processing...</div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Matrix rain animation
        function setupMatrixRain() {
            const canvas = document.getElementById('matrix-rain');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const columns = Math.floor(canvas.width / 20);
            const drops = [];
            
            for (let i = 0; i < columns; i++) {
                drops[i] = Math.floor(Math.random() * canvas.height);
            }
            
            function drawMatrixRain() {
                ctx.fillStyle = 'rgba(0, 8, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#00ff00';
                ctx.font = '15px monospace';
                
                for (let i = 0; i < drops.length; i++) {
                    const text = String.fromCharCode(0x30A0 + Math.floor(Math.random() * 95));
                    ctx.fillText(text, i * 20, drops[i] * 20);
                    
                    if (drops[i] * 20 > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            
            return setInterval(drawMatrixRain, 50);
        }
        
        // Initialize the app
        const initApp = () => {
            // Start the Matrix rain animation
            const matrixInterval = setupMatrixRain();
            
            // Simulate loading time (2 seconds)
            setTimeout(() => {
                // Hide the loading screen
                document.getElementById('loading').style.display = 'none';
                
                // Render the React app
                ReactDOM.render(
                    <App />,
                    document.getElementById('root')
                );
                
                // Clean up matrix rain animation
                clearInterval(matrixInterval);
            }, 2000);
        };
        
        // Start the application
        initApp();
    </script>
</body>
</html>